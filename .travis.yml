language: android
dist: trusty
jdk: oraclejdk8


env:
  global:
    - ANDROID_API_LEVEL=25
    - ANDROID_BUILD_TOOLS_VERSION=25.0.2
android:
  licenses:
    - 'android-sdk-preview-license-.+'
    - 'android-sdk-license-.+'
    - 'google-gdk-license-.+'
  components:
    - tools
    - platform-tools
    # The BuildTools version used by your project
    - build-tools-$ANDROID_BUILD_TOOLS_VERSION
    # The SDK version used to compile your project
    - android-$ANDROID_API_LEVEL
    # Additional components
    - extra-google-google_play_services
    - extra-google-m2repository
    - extra-android-m2repository
    - addon-google_apis-google-$ANDROID_API_LEVEL

# Cache gradle dependencies (should be faster to download them from cache)
cache:
  directories:
    - $HOME/.gradle/wrapper
    - $HOME/.gradle/caches/modules-2/files-2.1

# Setup environment
before_install:
  - chmod +x gradlew

before_deploy:
  # Generate a packaged jar for the desktop-project and rename it to include the tag
  - ./gradlew desktop:dist
  - mv desktop/build/libs/desktop-1.0.jar desktop/build/libs/{PROJECT_NAME}-$TRAVIS_TAG.jar
  # Generate a packaged apk for the android-project and rename it (this apk is unsigned/unaligned)
  - ./gradlew android:assembleRelease
  - mv android/build/outputs/apk/android-release-unsigned.apk android/build/outputs/apk/{PROJECT_NAME}-$TRAVIS_TAG-unaligned.apk
  # Generate and zip deployment files for the HTML project
  - ./gradlew html:dist
  - zip -r {PROJECT_NAME}-$TRAVIS_TAG.zip ./html/build/dist/
deploy:
  provider: releases
  api_key:
    secure: {DEPLOYMENT_KEY}
  file:
    # Define which files should be deployed to GitHub
    - desktop/build/libs/{PROJECT_NAME}-$TRAVIS_TAG.jar
    - android/build/outputs/apk/{PROJECT_NAME}-$TRAVIS_TAG-unaligned.apk
    - {PROJECT_NAME}-$TRAVIS_TAG.zip
    on:
      tags: true
      repo: {GITHUB_USER}/{PROJECT_NAME}
      branches: master
      condition: "$TRAVIS_TAG =~ ^v\d+\.\d+\.\d+.*$" # Only deploy tags that match something like v1.0.0